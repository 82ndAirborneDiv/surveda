<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="../css/app.css">
    <title>InSTEDD Ask</title>
  </head>

  <body class="welcome login">
    <div class='wrapper'>
        <header>
          <nav>
            <div class='nav-wrapper'>
              <a href="/" class="brand-logo">
                <svg version="1.1"  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                   viewBox="0 0 114 60" width="114px">
                  <rect x="26" y="14" transform="matrix(-1 -4.183688e-11 4.183688e-11 -1 60 56)" class="st0" width="8" height="28"/>
                  <rect x="36" y="23" class="st1" width="8" height="19"/>
                  <polygon class="st2" points="36,23 44,31 44,42 36,42 "/>
                  <rect x="16" y="33" class="st3" width="8" height="9"/>
                  <path class="st4" d="M60,30c0,16.6-13.4,30-30,30S0,46.6,0,30S13.4,0,30,0S60,13.4,60,30z M30,1C14,1,1,14,1,30s13,29,29,29
                    s29-13,29-29S46,1,30,1z"/>
                  <g>
                    <g>
                      <path class="st5" d="M71.3,40.6c0-0.1,0-0.2,0.1-0.4l6.6-18.4c0.1-0.3,0.5-0.4,1.1-0.4H80c0.7,0,1,0.1,1.1,0.4l6.6,18.4
                        c0.1,0.1,0.1,0.3,0.1,0.4c0,0.3-0.4,0.5-1.2,0.5h-0.2c-0.7,0-1-0.1-1.1-0.4L83.6,36h-8.2l-1.6,4.6c-0.1,0.3-0.5,0.4-1.1,0.4h-0.1
                        C71.7,41.1,71.3,40.9,71.3,40.6z M76.2,33.9h6.7l-2.9-8.3l-0.4-1.6l-0.4,1.6L76.2,33.9z"/>
                      <path class="st5" d="M89.1,39.5c0-0.2,0.1-0.5,0.4-0.8c0.2-0.4,0.4-0.6,0.6-0.6c0,0,0.2,0.1,0.4,0.3c0.3,0.2,0.7,0.4,1.2,0.5
                        s1.2,0.3,1.9,0.3c0.7,0,1.3-0.2,1.8-0.6c0.5-0.4,0.7-1,0.7-1.7c0-0.7-0.2-1.3-0.6-1.7c-0.4-0.4-1.3-0.8-2.5-1.1
                        c-1.3-0.4-2.2-0.8-2.7-1.4c-0.6-0.6-0.8-1.4-0.8-2.5c0-1.1,0.4-2.1,1.3-2.8c0.9-0.8,2-1.1,3.4-1.1c1,0,1.8,0.1,2.5,0.4
                        c0.7,0.2,1.1,0.5,1.1,0.8c0,0.2-0.1,0.6-0.3,0.9c-0.2,0.4-0.4,0.6-0.6,0.6c0,0-0.1-0.1-0.4-0.2c-0.6-0.3-1.3-0.5-2.1-0.5
                        s-1.4,0.2-1.8,0.5c-0.4,0.3-0.7,0.8-0.7,1.3c0,0.5,0.2,0.9,0.5,1.2c0.3,0.3,0.9,0.6,1.7,0.8c1.8,0.5,2.9,1.1,3.6,1.8
                        c0.6,0.6,0.9,1.6,0.9,2.9s-0.5,2.4-1.4,3.2c-0.9,0.8-2,1.3-3.3,1.3s-2.4-0.2-3.3-0.6C89.6,40.2,89.1,39.8,89.1,39.5z"/>
                      <path class="st5" d="M102.4,40.4V20.6c0-0.4,0.4-0.6,1.1-0.6h0.1c0.7,0,1.1,0.2,1.1,0.6v12.5h0.1l5.3-6.4c0.2-0.3,0.7-0.4,1.5-0.4
                        h0.1c0.7,0,1,0.1,1,0.4c0,0.2-0.1,0.4-0.3,0.6l-5.2,6.2l5.8,6.8c0.2,0.2,0.3,0.3,0.3,0.4c0,0.3-0.4,0.4-1.2,0.4h-0.1
                        c-0.8,0-1.3-0.1-1.5-0.4l-5.6-6.6h-0.1v6.4c0,0.4-0.4,0.6-1.1,0.6h-0.1C102.7,41.1,102.4,40.9,102.4,40.4z"/>
                    </g>
                  </g>
                </svg>
                <a href="#" data-activates="mobile-demo" class="button-collapse grey-text"><i class="material-icons">menu</i></a>
              </a>
              <ul class="right hide-on-med-and-down">
                <li><a href="#" class="btn-flat btn-large">About Instedd Platform</a></li>
                <li><a href='/login' class="btn-flat btn-large">Login</a></li>
                <li><a href="/register" class="btn-flat btn-large outlined">Sign up for free</a></li>
              </ul>
              <ul class="side-nav" id="mobile-demo">
                <li><a href="#" class="btn-flat btn-large">About Instedd Platform</a></li>
                <li><a href='/login' class="btn-flat btn-large">Login</a></li>
                <li><a href="/register" class="btn-flat btn-large outlined">Sign up for free</a></li>
              </ul>
            </div>
          </nav>
        </header>

        <main role="main" class="main-welcome valign-wrapper">
          <input type="hidden" id="csrf-token" value="<%= @csrf_token %>">
          <%= render @view_module, @view_template, assigns %>
        </main>
        <footer>
            <div class="row">
              <div class="col m9 s12">
                <ul>
                  <li><a href="#!">InSTEDD</a></li>
                  <li><a href="#!">Terms of service</a></li>
                  <li><a href="#!">Support</a></li>
                </ul>
              </div>
              <div class="col m2 offset-m1 s12">
                <p class="center-align">Version: <%= Application.get_env(:ask, :version) %> </p>
              </div>
            </div>
        </footer>
      </div>
    <script type="text/javascript">

      var btn_register = document.getElementById("btn-register");
      var btn_logout = document.getElementById("btn-logout");
      var btn_login = document.getElementById("btn-login");
      var btn_reset = document.getElementById("btn-reset-password");
      var btn_send = document.getElementById("btn-send-reset-password-link");

      function navigateToRoot() {
        window.location.href = "/";
      }

      function addErrors(errors) {
        var el = document.getElementsByClassName('errors')[0];

        function appendError(error_message, el) {
          var el_error = document.createElement("p");
          el_error.setAttribute("class", "addict error-message");
          el_error.innerText = error_message;
          el.appendChild(el_error);
        }

        if (errors) {
          errors = errors.errors;
          var i = errors.length - 1;
          errors.forEach(function(error) {
            appendError(error.message, el);
          });
        } else {
          appendError("Something went wrong, please try again", el);
        }
      }

      function clearErrors() {
        var el = document.getElementsByClassName('errors')[0];
        el.childNodes.length > 0 && Array.prototype.slice.call(el.childNodes).forEach(function(node){
          el.removeChild(node);
        });
      }

      function makeRequest(url, data, csrf_token, success_callback, failure_callback, method) {
        clearErrors();
        method = method || "POST";
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open(method, url);
        xmlHttp.setRequestHeader("x-csrf-token", csrf_token);
        xmlHttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlHttp.onreadystatechange = function() {
          if (xmlHttp.readyState == 4) {
            if (xmlHttp.status >= 200 && xmlHttp.status < 400) {
              success_callback && success_callback();
            } else if (xmlHttp.status >= 400 && xmlHttp.status < 500){
              failure_callback && failure_callback(JSON.parse(xmlHttp.responseText));
            } else {
              failure_callback && failure_callback(null);
            }
          }
        }
        xmlHttp.send(JSON.stringify(data));
      }

      if(btn_register){
        document.getElementById("btn-register").addEventListener("click", function(ev) {
          var name = document.getElementById('txt-name').value;
          var email = document.getElementById('txt-email').value;
          var password = document.getElementById('txt-password').value;
          var csrf_token = document.getElementById('csrf-token').value;
          var params = {
            name: name,
            email: email,
            password: password
          };
          makeRequest('/register', params, csrf_token, navigateToRoot, addErrors);
        }, false);
      }

      if(btn_logout){
        document.getElementById("btn-logout").addEventListener("click", function(ev) {
          var csrf_token = document.getElementById('csrf-token').value;
          makeRequest('/logout', {}, csrf_token, navigateToRoot, null, "DELETE");
        }, false);
      }

      if(btn_login){
        document.getElementById("btn-login").addEventListener("click", function(ev) {
          var email = document.getElementById('txt-email').value;
          var password = document.getElementById('txt-password').value;
          var csrf_token = document.getElementById('csrf-token').value;
          var params = {
            email: email,
            password: password
          };
          makeRequest('/login', params, csrf_token, navigateToRoot, addErrors);
        }, false);
      }

      if(btn_reset){
        document.getElementById("btn-reset-password").addEventListener("click", function(ev) {
          var password = document.getElementById('txt-password').value;
          var token = document.getElementById('token').value;
          var signature = document.getElementById('signature').value;
          var csrf_token = document.getElementById('csrf-token').value;

          var params = {
            signature: signature,
            token: token,
            password: password
          };
          makeRequest('/reset_password', params, csrf_token, navigateToRoot, addErrors);
        }, false);
      }

      if(btn_send){
        document.getElementById("btn-send-reset-password-link").addEventListener("click", function(ev) {
          var email = document.getElementById('txt-email').value;
          var csrf_token = document.getElementById('csrf-token').value;

          var params = { email: email };
          makeRequest('/recover_password', params, csrf_token, navigateToRoot, addErrors);
        }, false);
      }

    </script>
    <script src="../js/app.js"></script>
  </body>
</html>
